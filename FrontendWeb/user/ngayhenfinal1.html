<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch hẹn của bạn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="images/icons/favicon.png" />
    <link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/iconic/css/material-design-iconic-font.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/linearicons-v1.0.0/icon-font.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
    <link rel="stylesheet" type="text/css" href="vendor/css-hamburgers/hamburgers.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/animsition/css/animsition.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/select2/select2.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/MagnificPopup/magnific-popup.css">
    <link rel="stylesheet" type="text/css" href="vendor/slick/slick.css">

    <link rel="stylesheet" type="text/css" href="vendor/daterangepicker/daterangepicker.css">
    <link rel="stylesheet" type="text/css" href="vendor/perfect-scrollbar/perfect-scrollbar.css">
    <link rel="stylesheet" type="text/css" href="css/util.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link href="css/sb-admin-2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/dataTables.dataTables.min.css">
</head>

<body class="animsition bg-light">
    <header>
        <div class="container-menu-desktop">

            <div class="wrap-menu-desktop bg-white shadow-sm">
                <nav class="limiter-menu-desktop container">

                    <a href="#" class="logo">
                        <img src="images/icons/logo-01.png" alt="IMG-LOGO">
                    </a>

                    <div class="menu-desktop">
                        <ul class="main-menu">
                            <li>
                                <a href="index.html">Trang chủ</a>

                            </li>

                            <li>
                                <a href="blog.html">Bài viết</a>
                            </li>

                            <li>
                                <a href="about.html">Về chúng tôi</a>
                            </li>

                            <li>
                                <a href="contact.html">Liên hệ</a>
                            </li>


                            <li class="active-menu">
                                <a href="/FrontendWeb/user/ngayhenfinal1.html">
                                    Đặt lịch
                                </a>
                            </li>


                        </ul>
                    </div>

                    <div class="wrap-icon-header flex-w flex-r-m">


                        <div class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 icon-header-noti js-show-cart"
                            data-notify="2">
                            <i class="zmdi zmdi-shopping-cart"></i>
                        </div>




                        <li class="nav-item dropdown no-arrow">

                            <a data-toggle="dropdown" id="userDropdown"
                                class="nav-link dropdown-toggle dis-block icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 icon-header-account">
                                <i class="zmdi zmdi-account"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-left shadow animated--grow-in start-50"
                                aria-labelledby="userDropdown">
                                <a class="dropdown-item" href="hoso.html">
                                    Cá nhân
                                </a>
                                <div class="dropdown-divider"></div>
                                <a onclick="dangXuat()" class="dropdown-item" href="#" data-toggle="modal"
                                    data-target="#logoutModal">
                                    Đăng xuất
                                </a>
                            </div>
                        </li>
                    </div>
                </nav>
            </div>
        </div>

        <div class="wrap-header-mobile">
            <div class="logo-mobile">
                <a href="index.html"><img src="images/icons/logo-01.png" alt="IMG-LOGO"></a>
            </div>

            <div class="wrap-icon-header flex-w flex-r-m m-r-15">


                <div class="icon-header-item cl2 hov-cl1 trans-04 p-r-11 p-l-10 icon-header-noti js-show-cart"
                    data-notify="2">
                    <i class="zmdi zmdi-shopping-cart"></i>
                </div>

                <a href="#" class="dis-block icon-header-item cl2 hov-cl1 trans-04 p-r-11 p-l-10 icon-header-noti"
                    data-notify="0">

                </a>
            </div>

            <div class="btn-show-menu-mobile hamburger hamburger--squeeze">
                <span class="hamburger-box">
                    <span class="hamburger-inner"></span>
                </span>
            </div>
        </div>

        <div class="menu-mobile">
            <ul class="topbar-mobile">
                <li>
                    <div class="left-top-bar">
                        Free shipping for standard order over $100
                    </div>
                </li>

                <li>
                    <div class="right-top-bar flex-w h-full">
                        <a href="#" class="flex-c-m p-lr-10 trans-04">
                            Help & FAQs
                        </a>

                        <a href="#" class="flex-c-m p-lr-10 trans-04">
                            Tài khoản cá nhân
                        </a>

                        <a href="#" class="flex-c-m p-lr-10 trans-04">
                            EN
                        </a>

                        <a href="#" class="flex-c-m p-lr-10 trans-04">
                            USD
                        </a>
                    </div>
                </li>
            </ul>

            <ul class="main-menu-m">
                <li>
                    <a href="index.html">Trang chủ</a>

                    <span class="arrow-main-menu-m">
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </span>
                </li>

                <li>
                    <a href="product.html">Shop</a>
                </li>

                <li>
                    <a href="shoping-cart.html" class="label1 rs1" data-label1="hot">Features</a>
                </li>

                <li>
                    <a href="blog.html">Blog</a>
                </li>

                <li>
                    <a href="about.html">Về chúng tôi</a>
                </li>

                <li>
                    <a href="contact.html">Contact</a>
                </li>
            </ul>
        </div>

    </header>


    <div class="wrap-header-cart js-panel-cart">
        <div class="s-full js-hide-cart"></div>

        <div class="header-cart flex-col-l p-l-65 p-r-25">
            <div class="header-cart-title flex-w flex-sb-m p-b-8">
                <span class="mtext-103 cl2">
                    Giỏ hàng của bạn
                </span>

                <div class="fs-35 lh-10 cl2 p-lr-5 pointer hov-cl1 trans-04 js-hide-cart">
                    <i class="zmdi zmdi-close"></i>
                </div>
            </div>

        </div>
    </div>


    <section class="bg-img1 txt-center p-lr-15 p-t-150 p-b-92" style="background-image: url('images/bg-01.jpg');">
        <h2 class="ltext-105 cl0 txt-center">
            Lịch hẹn của tôi
        </h2>
    </section>

    <div class="container py-5">
        <div class="row">
            <div class="col-lg-8">
                <div class="alert alert-info text-center" id="userInfo">Đang tải thông tin người dùng...</div>

                <div class="card mb-4 shadow-sm border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Lịch hẹn hiện tại của bạn</h5>
                    </div>
                    <div class="card-body">
                        <div id="lichHienTai" class="list-group">
                            <p class="text-muted">Đang tải...</p>
                        </div>
                        <small class="mt-2 text-muted d-block">* Chọn một lịch hẹn để Cập nhật hoặc Hủy.</small>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Bạn muốn?</h5>

                        <ul class="nav nav-pills nav-fill mb-4" id="actionTabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="tab-dat" data-action="dat" onclick="showForm('dat')">Đặt
                                    lịch</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="tab-update" data-action="update"
                                    onclick="showForm('update')">Cập nhật lịch</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="tab-huy" data-action="huy" onclick="showForm('huy')">Hủy
                                    lịch</a>
                            </li>
                        </ul>

                        <div id="formDat">
                            <p class="text-muted mb-3">Chọn ngày và giờ bạn muốn đặt lịch mới:</p>
                            <div class="mb-3">
                                <label for="ngayDat" class="form-label">Ngày</label>
                                <input type="date" id="ngayDat" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="gioDat" class="form-label">Giờ</label>
                                <input type="time" id="gioDat" class="form-control" required>
                            </div>
                            <small class="text-danger d-block mb-3">
                                Không thể đặt lịch vào ngày đã qua hoặc ngoài giờ làm việc (T2-T6, 8:00 - 11:00 sáng và
                                1:00 - 5:00 chiều).
                            </small>
                            <button class="btn btn-success w-100" onclick="datLich()">
                                <i class="fa fa-calendar-plus-o"></i> Đặt lịch ngay
                            </button>
                        </div>

                        <div id="formUpdate" style="display:none;">
                            <p class="text-muted mb-3">Chọn ngày và giờ mới cho lịch hẹn đã chọn:</p>
                            <div class="mb-3">
                                <label for="ngayUpdate" class="form-label">Ngày mới</label>
                                <input type="date" id="ngayUpdate" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="gioUpdate" class="form-label">Giờ mới</label>
                                <input type="time" id="gioUpdate" class="form-control" required>
                            </div>
                            <small class="text-danger d-block mb-3">
                                Không thể cập nhật lịch hẹn về ngày đã qua hoặc ngoài giờ làm việc (T2-T6, 8:00 - 11:00
                                sáng và 1:00 - 5:00 chiều).
                            </small>
                            <button class="btn btn-warning w-100" onclick="updateLich()">
                                <i class="fa fa-refresh"></i> Cập nhật lịch
                            </button>
                        </div>

                        <div id="formHuy" style="display:none;">
                            <p class="text-danger mb-4">Bạn chắc chắn muốn hủy lịch hẹn đã chọn?</p>
                            <button class="btn btn-danger w-100" onclick="huyLich()">
                                <i class="fa fa-trash"></i> Hủy lịch này
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
            <div id="toast" class="toast align-items-center text-bg-primary border-0">
                <div class="d-flex">
                    <div class="toast-body" id="toastMessage"></div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>
    </div>



    <footer class="bg3 p-t-75 p-b-32">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-lg-3 p-b-50">
                    <h4 class="stext-301 cl0 p-b-30">
                        Danh mục
                    </h4>

                    <ul>
                        <li class="p-b-10">
                            <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                                Nữ
                            </a>
                        </li>

                        <li class="p-b-10">
                            <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                                Nam
                            </a>
                        </li>

                        <li class="p-b-10">
                            <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                                Vòng tay
                            </a>
                        </li>

                        <li class="p-b-10">
                            <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                                Khuyên tai
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="col-sm-6 col-lg-3 p-b-50">
                    <h4 class="stext-301 cl0 p-b-30">
                        Trợ giúp
                    </h4>

                    <ul>
                        <li class="p-b-10">
                            <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                                Theo dõi đơn hàng
                            </a>
                        </li>

                        <li class="p-b-10">
                            <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                                Đổi trả
                            </a>
                        </li>

                        <li class="p-b-10">
                            <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                                Vận chuyển
                            </a>
                        </li>

                        <li class="p-b-10">
                            <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                                Câu hỏi thường gặp
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="col-sm-6 col-lg-3 p-b-50">
                    <h4 class="stext-301 cl0 p-b-30">
                        Liên hệ
                    </h4>

                    <p class="stext-107 cl7 size-201">
                        Nếu có bất kỳ thắc mắc nào? Hãy ghé thăm cửa hàng của chúng tôi tại tầng 8, 379 Hudson St,
                        New York, NY 10018 hoặc gọi cho chúng tôi theo số (+1) 96 716 6879
                    </p>

                    <div class="p-t-27">
                        <a href="#" class="fs-18 cl7 hov-cl1 trans-04 m-r-16">
                            <i class="fa fa-facebook"></i>
                        </a>

                        <a href="#" class="fs-18 cl7 hov-cl1 trans-04 m-r-16">
                            <i class="fa fa-instagram"></i>
                        </a>

                        <a href="#" class="fs-18 cl7 hov-cl1 trans-04 m-r-16">
                            <i class="fa fa-pinterest-p"></i>
                        </a>
                    </div>
                </div>

                <div class="col-sm-6 col-lg-3 p-b-50">
                    <h4 class="stext-301 cl0 p-b-30">
                        Nhận tin khuyến mãi
                    </h4>

                    <form>
                        <div class="wrap-input1 w-full p-b-4">
                            <input class="input1 bg-none plh1 stext-107 cl7" type="text" name="email"
                                placeholder="email@example.com">
                            <div class="focus-input1 trans-04"></div>
                        </div>

                        <div class="p-t-18">
                            <button class="flex-c-m stext-101 cl0 size-103 bg1 bor1 hov-btn2 p-lr-15 trans-04">
                                Đăng ký
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="p-t-40">
                <div class="flex-c-m flex-w p-b-18">
                    <a href="#" class="m-all-1">
                        <img src="images/icons/icon-pay-01.png" alt="Phương thức thanh toán">
                    </a>

                    <a href="#" class="m-all-1">
                        <img src="images/icons/icon-pay-02.png" alt="Phương thức thanh toán">
                    </a>

                    <a href="#" class="m-all-1">
                        <img src="images/icons/icon-pay-03.png" alt="Phương thức thanh toán">
                    </a>

                    <a href="#" class="m-all-1">
                        <img src="images/icons/icon-pay-04.png" alt="Phương thức thanh toán">
                    </a>

                    <a href="#" class="m-all-1">
                        <img src="images/icons/icon-pay-05.png" alt="Phương thức thanh toán">
                    </a>
                </div>


            </div>
        </div>
    </footer>



    <div class="btn-back-to-top" id="myBtn">
        <span class="symbol-btn-back-to-top">
            <i class="zmdi zmdi-chevron-up"></i>
        </span>
    </div>
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Bạn muốn đăng xuất?</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">Chọn "Đăng xuất" bên dưới nếu bạn thực sự muốn kết thúc phiên làm việc.</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Hủy</button>
                    <a class="btn btn-primary" href="/FrontendWeb/user/myloginfinal1.html">Đăng xuất</a>
                </div>
            </div>
        </div>
    </div>

    <script src="vendor/jquery/jquery-3.2.1.min.js"></script>
    <script src="vendor/animsition/js/animsition.min.js"></script>
    <script src="vendor/bootstrap/js/popper.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="vendor/select2/select2.min.js"></script>
    <script>
        $(".js-select2").each(function () {
            $(this).select2({
                minimumResultsForSearch: 20,
                dropdownParent: $(this).next('.dropDownSelect2')
            });
        })
    </script>
    <script src="vendor/daterangepicker/moment.min.js"></script>
    <script src="vendor/daterangepicker/daterangepicker.js"></script>
    <script src="vendor/slick/slick.min.js"></script>
    <script src="js/slick-custom.js"></script>
    <script src="vendor/parallax100/parallax100.js"></script>
    <script>
        $('.parallax100').parallax100();
    </script>
    <script src="vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
    <script>
        $('.gallery-lb').each(function () { // the containers for all your galleries
            $(this).magnificPopup({
                delegate: 'a', // the selector for gallery item
                type: 'image',
                gallery: {
                    enabled: true
                },
                mainClass: 'mfp-fade'
            });
        });
    </script>
    <script src="vendor/isotope/isotope.pkgd.min.js"></script>
    <script src="vendor/sweetalert/sweetalert.min.js"></script>
    <script>
        // SweetAlert scripts from index.html (optional, but included for completeness)
        $('.js-addwish-b2').on('click', function (e) {
            e.preventDefault();
        });

        $('.js-addwish-b2').each(function () {
            var nameProduct = $(this).parent().parent().find('.js-name-b2').html();
            $(this).on('click', function () {
                swal(nameProduct, "is added to wishlist !", "success");

                $(this).addClass('js-addedwish-b2');
                $(this).off('click');
            });
        });

        $('.js-addwish-detail').each(function () {
            var nameProduct = $(this).parent().parent().parent().find('.js-name-detail').html();

            $(this).on('click', function () {
                swal(nameProduct, "is added to wishlist !", "success");

                $(this).addClass('js-addedwish-detail');
                $(this).off('click');
            });
        });
    </script>
    <script src="vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script>
        $('.js-pscroll').each(function () {
            $(this).css('position', 'relative');
            $(this).css('overflow', 'hidden');
            var ps = new PerfectScrollbar(this, {
                wheelSpeed: 1,
                scrollingThreshold: 1000,
                wheelPropagation: false,
            });

            $(window).on('resize', function () {
                ps.update();
            })
        });
    </script>
    <script src="js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Adjust API URL to the running backend port (change if your API uses a different port)
        const API_URL = "http://localhost:5150/api/Ngayhen";
        const toast = new bootstrap.Toast(document.getElementById('toast'));

        function getUserId() {
            try {
                const user = JSON.parse(localStorage.getItem("currentUser"));
                const id = user && (user.id || user.Id || user.ID);
                if (!user || !id) {
                    alert("Chưa đăng nhập!");
                    window.location.href = "/FrontendWeb/user/myloginfinal1.html";
                    return null;
                }
                return id;
            } catch (e) {
                alert("Lỗi lưu trữ, vui lòng đăng nhập lại!");
                localStorage.removeItem("currentUser");
                window.location.href = "/FrontendWeb/user/myloginfinal1.html";
                return null;
            }
        }

        // Gọi API với userId
        async function callApi(url, options = {}) {
            const userId = getUserId();
            if (!userId) return null;

            const fullUrl = url.includes('?') ? `${url}&userId=${userId}` : `${url}?userId=${userId}`;

            const res = await fetch(fullUrl, {
                ...options,
                headers: { 'Content-Type': 'application/json', ...options.headers }
            });

            const text = await res.text();
            try {
                const data = text ? JSON.parse(text) : null;
                if (!res.ok) {
                    const msg = data?.message || data?.error || res.statusText || "Lỗi không xác định";
                    showToast(msg, "danger");
                }
                return { res, data };
            } catch (err) {
                showToast("Lỗi phân tích dữ liệu từ server", "danger");
                return { res, data: null };
            }
        }

        function showToast(msg, type = "primary") {
            document.getElementById('toastMessage').innerText = msg;
            // Class text-bg-${type} sẽ áp dụng màu nền (bg) và màu chữ (text) phù hợp (ví dụ: text-bg-success)
            document.getElementById('toast').className = `toast align-items-center text-bg-${type} border-0`;
            toast.show();
        }

        function getUser() {
            try {
                const user = JSON.parse(localStorage.getItem("currentUser"));
                if (!user) { window.location.href = "/FrontendWeb/user/myloginfinal1.html"; return null; }
                return user;
            } catch (e) {
                return null;
            }
        }

        function hienThiUser() {
            const user = getUser();
            if (!user) {
                document.getElementById("userInfo").innerHTML = "Chưa đăng nhập";
                return;
            }
            const name = user.hoTen || user.HoTen || user.tenDn || user.TenDn || user.name || "Người dùng";
            const id = user.id || user.Id || user.ID || "";
            // document.getElementById("userInfo").innerHTML = `<strong>Xin chào, ${name}</strong> ${id ? `(ID: ${id})` : ''}`;
            document.getElementById("userInfo").innerHTML = `<strong>Xin chào, ${name}</strong> `;
        }

        function showForm(action) {
            // Loại bỏ active từ tất cả các tab
            document.querySelectorAll('#actionTabs a').forEach(tab => {
                tab.classList.remove('active');
            });

            // Hiển thị form tương ứng và đặt active cho tab
            let v = action || document.querySelector('#actionTabs a[data-action="dat"]').dataset.action; // Default to 'dat' if no action is provided
            document.getElementById("formDat").style.display = v === "dat" ? "block" : "none";
            document.getElementById("formUpdate").style.display = v === "update" ? "block" : "none";
            document.getElementById("formHuy").style.display = v === "huy" ? "block" : "none";

            // Đặt active cho tab
            document.getElementById(`tab-${v}`).classList.add('active');
        }

        // keep track of selected appointment id for update/delete
        let selectedAppointmentId = null;

        // --- BẮT ĐẦU LOGIC GIỜ LÀM VIỆC ---

        /**
         * Kiểm tra xem ngày và giờ có nằm trong giờ làm việc (9h sáng - 5h chiều, T2 - T6) hay không.
         * @param {string} dateString Ngày (YYYY-MM-DD)
         * @param {string} timeString Giờ (HH:MM)
         * @returns {boolean} True nếu nằm trong giờ làm việc, ngược lại là False.
         */
        function isWorkingHoursAndDay(dateString, timeString) {
            const d = new Date(`${dateString}T${timeString}:00`);
            const dayOfWeek = d.getDay(); // 0 = Chủ Nhật, 1 = Thứ Hai, ..., 6 = Thứ Bảy
            const hour = d.getHours();

            // Kiểm tra Ngày (Thứ Hai đến Thứ Sáu: 1 đến 5)
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return false; // Ngoài giờ làm việc (Cuối tuần)
            }

            // Kiểm tra Giờ (9:00 đến 17:00)
            // Giả sử giờ làm việc là [9:00, 17:00), tức là từ 9:00:00 đến 16:59:59
            if (hour < 8 || hour >= 17) {
                return false; // Ngoài giờ làm việc (Trước 8h sáng hoặc từ 5h chiều trở đi)
            }

            return true; // Trong giờ làm việc
        }

        /**
         * Thiết lập ngày tối thiểu cho input date là ngày hiện tại (YYYY-MM-DD).
         * Ngăn người dùng chọn ngày trong quá khứ ở frontend (dùng thuộc tính min).
         */
        function setMinDate() {
            const now = new Date();
            // Lấy ngày hiện tại ở định dạng YYYY-MM-DD
            const minDate = now.toISOString().split('T')[0];

            // Áp dụng cho form đặt lịch
            const ngayDat = document.getElementById('ngayDat');
            if (ngayDat) {
                ngayDat.min = minDate;
            }
            // Tương tự cho form cập nhật
            const ngayUpdate = document.getElementById('ngayUpdate');
            if (ngayUpdate) {
                ngayUpdate.min = minDate;
            }
        }
        // --- KẾT THÚC LOGIC GIỜ LÀM VIỆC (Hàm isWorkingHoursAndDay) ---


        async function layLichHienTai() {
            const { res, data } = await callApi(`${API_URL}/cua-toi`) || {};
            const container = document.getElementById("lichHienTai");
            container.innerHTML = '';

            if (!res) return container.innerHTML = `<p class="text-muted">Lỗi xác thực</p>`;
            if (!res.ok) return container.innerHTML = `<p class="text-danger">${data?.message || 'Lỗi khi lấy lịch'}</p>`;

            const arr = Array.isArray(data) ? data : (data ? [data] : []);
            if (arr.length === 0) {
                container.innerHTML = `<div class="p-3 bg-light text-center"><i class="fa fa-info-circle"></i> Bạn không có lịch hẹn nào còn hiệu lực. Hãy đặt lịch ngay để được chúng tôi tư vấn!</div>`;
                selectedAppointmentId = null;
                return;
            }

            // Render list with radio buttons to select appointment (Sử dụng list-group)
            arr.forEach((item, idx) => {
                const dateStr = item.ngay || item.Ngay || item.Ngayhen || null;
                const d = dateStr ? new Date(dateStr) : null;
                const id = item.id || item.Id;
                const status = item.trangThai || item.TrangThai || 'Đã đặt';
                const statusClass = status.includes('Hủy') ? 'text-danger' : 'text-success';

                const itemHtml = document.createElement('label');
                itemHtml.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-center ${idx === 0 ? 'active' : ''}`;
                itemHtml.innerHTML = `
                    <div>
                        <input class="form-check-input me-1" type="radio" name="lichSelect" id="lich_${id}" value="${id}" ${idx === 0 ? 'checked' : ''}>
                        <strong class="mb-1">Lịch hẹn #${id}</strong>
                        <div class="text-muted small">${d ? d.toLocaleString('vi-VN') : 'Không có ngày'}</div>
                    </div>
                    <span class="badge ${statusClass} bg-opacity-10">${status}</span>
                `;

                // Xử lý sự kiện khi chọn radio
                itemHtml.querySelector('input').addEventListener('change', () => {
                    selectedAppointmentId = id;
                    // Cập nhật trạng thái active của list-group-item
                    document.querySelectorAll('#lichHienTai label').forEach(l => l.classList.remove('active'));
                    itemHtml.classList.add('active');

                    // Populate update form (Tách ngày và giờ)
                    if (d) {
                        document.getElementById('ngayUpdate').value = d.toISOString().split('T')[0];
                        // Lấy HH:MM
                        document.getElementById('gioUpdate').value = d.toTimeString().split(':').slice(0, 2).join(':');
                    }
                });

                // Đặt selectedAppointmentId cho lịch hẹn đầu tiên
                if (idx === 0) selectedAppointmentId = id;

                container.appendChild(itemHtml);
            });

            // Populate update form with first appointment (Tách ngày và giờ)
            const first = arr[0];
            const firstDate = first?.ngay || first?.Ngay;
            if (firstDate) {
                const d0 = new Date(firstDate);
                document.getElementById('ngayUpdate').value = d0.toISOString().split('T')[0];
                document.getElementById('gioUpdate').value = d0.toTimeString().split(':').slice(0, 2).join(':');
            }
        }

        async function datLich() {
            const n = document.getElementById("ngayDat").value;
            const g = document.getElementById("gioDat").value;
            if (!n || !g) return showToast("Vui lòng chọn Ngày và Giờ hẹn", "danger");

            // --- BẮT ĐẦU LOGIC KIỂM TRA NGÀY TRONG QUÁ KHỨ (FRONTEND) ---
            const appointmentDateTime = new Date(`${n}T${g}:00`);
            const now = new Date();

            if (appointmentDateTime <= now) {
                // Hiển thị thông báo lỗi và DỪNG việc gọi API
                return showToast("Không thể đặt lịch cho thời điểm đã qua. Vui lòng chọn ngày giờ trong tương lai.", "danger");
            }
            // --- KẾT THÚC LOGIC KIỂM TRA NGÀY TRONG QUÁ KHỨ (FRONTEND) ---

            // --- BẮT ĐẦU LOGIC KIỂM TRA GIỜ LÀM VIỆC MỚI ---
            if (!isWorkingHoursAndDay(n, g)) {
                return showToast("Lịch hẹn phải trong giờ làm việc (T2-T6, 8:00 - 11:00 sáng và 1:00 - 5:00 chiều)", "danger");
            }
            // --- KẾT THÚC LOGIC KIỂM TRA GIỜ LÀM VIỆC MỚI ---

            // Kết hợp ngày và giờ thành format ISO 8601 (YYYY-MM-DDTTHH:MM:00)
            const payload = { Ngay: `${n}T${g}:00` };

            const { res, data } = await callApi(`${API_URL}/datlich`, {
                method: "POST",
                body: JSON.stringify(payload)
            }) || {};

            showToast(data?.message || "Đặt lịch thành công", res?.ok ? "success" : "danger");
            await layLichHienTai();
        }

        async function updateLich() {
            const id = selectedAppointmentId;
            if (!id) return showToast('Chọn lịch để cập nhật', 'danger');
            const n = document.getElementById("ngayUpdate").value;
            const g = document.getElementById("gioUpdate").value;
            if (!n || !g) return showToast("Vui lòng chọn Ngày và Giờ mới", "danger");

            // --- BẮT ĐẦU LOGIC KIỂM TRA NGÀY TRONG QUÁ KHỨ (FRONTEND) ---
            const appointmentDateTime = new Date(`${n}T${g}:00`);
            const now = new Date();

            if (appointmentDateTime <= now) {
                // Hiển thị thông báo lỗi và DỪNG việc gọi API
                return showToast("Không thể cập nhật lịch hẹn về thời điểm đã qua. Vui lòng chọn ngày giờ trong tương lai.", "danger");
            }
            // --- KẾT THÚC LOGIC KIỂM TRA NGÀY TRONG QUÁ KHỨ (FRONTEND) ---

            // --- BẮT ĐẦU LOGIC KIỂM TRA GIỜ LÀM VIỆC MỚI ---
            if (!isWorkingHoursAndDay(n, g)) {
                return showToast("Lịch hẹn phải trong giờ làm việc (T2-T6, 8:00 - 11:00 sáng và 1:00 - 5:00 chiều)", "danger");
            }
            // --- KẾT THÚC LOGIC KIỂM TRA GIỜ LÀM VIỆC MỚI ---

            // Kết hợp ngày và giờ thành format ISO 8601 (YYYY-MM-DDTTHH:MM:00)
            const payload = { Ngay: `${n}T${g}:00` };

            const { res, data } = await callApi(`${API_URL}/update/${id}`, {
                method: "PUT",
                body: JSON.stringify(payload)
            }) || {};

            showToast(data?.message || "Cập nhật thành công", res?.ok ? "success" : "danger");
            await layLichHienTai();
        }

        async function huyLich() {
            const id = selectedAppointmentId;
            if (!id) return showToast('Chọn lịch để hủy', 'danger');
            if (!confirm("Bạn có chắc chắn muốn hủy lịch hẹn này?")) return;
            const { res, data } = await callApi(`${API_URL}/huy/${id}`, { method: "DELETE" }) || {};

            showToast(data?.message || "Đã hủy lịch hẹn", res?.ok ? "warning" : "danger");
            await layLichHienTai();
        }

        // Khởi chạy
        document.addEventListener("DOMContentLoaded", () => {
            hienThiUser();
            layLichHienTai();
            showForm('dat');
            setMinDate();
        });
    </script>
</body>

</html>