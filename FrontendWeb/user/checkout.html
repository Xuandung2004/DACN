<!DOCTYPE html>
<html lang="en">

<head>
    <title>Thanh To√°n</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="images/icons/favicon.png" />
    <link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/iconic/css/material-design-iconic-font.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/linearicons-v1.0.0/icon-font.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
    <link rel="stylesheet" type="text/css" href="vendor/css-hamburgers/hamburgers.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/animsition/css/animsition.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/select2/select2.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/perfect-scrollbar/perfect-scrollbar.css">
    <link rel="stylesheet" type="text/css" href="css/util.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <style>
        .checkout-container {
            background-color: #f8f9fa;
            padding: 30px 0;
            min-height: calc(100vh - 300px);
        }

        .checkout-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #27ae60;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #27ae60;
            outline: none;
            box-shadow: 0 0 5px rgba(39, 174, 96, 0.2);
        }

        .payment-method {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .payment-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .payment-option input[type="radio"] {
            margin-right: 10px;
        }

        .payment-option.active {
            border-color: #27ae60;
            background-color: #f0fdf4;
        }

        .order-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .summary-row.total {
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
            border-top: 2px solid #ddd;
            padding-top: 12px;
            margin-top: 12px;
        }

        .product-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .product-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .product-info {
            flex: 1;
            font-size: 13px;
        }

        .product-info .product-name {
            font-weight: 600;
            color: #333;
        }

        .product-info .product-qty {
            color: #666;
        }

        .product-info .product-price {
            color: #27ae60;
            font-weight: 600;
            margin-top: 4px;
        }

        .btn-checkout {
            width: 100%;
            padding: 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 15px;
        }

        .btn-checkout:hover {
            background: #219150;
        }

        .btn-checkout:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-back {
            display: inline-block;
            margin-bottom: 20px;
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-decoration: none;
            color: #333;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-back:hover {
            background: #e0e0e0;
        }

        .alert-danger {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #c33;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #1565c0;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .payment-method {
                flex-direction: column;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #27ae60;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="animsition">

    <!-- Header -->
    <header class="header-v4">
        <div class="container-menu-desktop">
            <div class="top-bar">
                <div class="content-topbar flex-sb-m h-full container">
                    <div class="left-top-bar">
                        Free shipping for standard order over $100
                    </div>
                    <div class="right-top-bar flex-w h-full">
                        <a href="#" class="flex-c-m trans-04 p-lr-25">Help & FAQs</a>
                        <a href="#" class="flex-c-m trans-04 p-lr-25">My Account</a>
                        <a href="#" class="flex-c-m trans-04 p-lr-25">EN</a>
                        <a href="#" class="flex-c-m trans-04 p-lr-25">VN</a>
                    </div>
                </div>
            </div>

            <div class="wrap-menu-desktop how-shadow1">
                <nav class="limiter-menu-desktop container">
                    <a href="index.html" class="logo">
                        <img src="images/icons/logo-01.png" alt="IMG-LOGO">
                    </a>
                    <div class="menu-desktop">
                        <ul class="main-menu">
                            <li><a href="index.html">Home</a></li>
                            <li><a href="product.html">Shop</a></li>
                            <li><a href="shoping-cart.html">Features</a></li>
                            <li><a href="blog.html">Blog</a></li>
                            <li><a href="about.html">About</a></li>
                            <li><a href="contact.html">Contact</a></li>
                        </ul>
                    </div>
                    <div class="wrap-icon-header flex-w flex-r-m">
                        <div class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 js-show-modal-search">
                            <i class="zmdi zmdi-search"></i>
                        </div>
                        <div class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 icon-header-noti js-show-cart"
                            data-notify="2">
                            <i class="zmdi zmdi-shopping-cart"></i>
                        </div>
                        <a href="#" class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 icon-header-noti"
                            data-notify="0">
                            <i class="zmdi zmdi-favorite-outline"></i>
                        </a>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Header Mobile -->
        <div class="wrap-header-mobile">
            <div class="logo-mobile">
                <a href="index.html"><img src="images/icons/logo-01.png" alt="IMG-LOGO"></a>
            </div>
            <div class="wrap-icon-header flex-w flex-r-m m-r-15">
                <div class="icon-header-item cl2 hov-cl1 trans-04 p-r-11 js-show-modal-search">
                    <i class="zmdi zmdi-search"></i>
                </div>
                <div class="icon-header-item cl2 hov-cl1 trans-04 p-r-11 p-l-10 icon-header-noti js-show-cart"
                    data-notify="2">
                    <i class="zmdi zmdi-shopping-cart"></i>
                </div>
                <a href="#" class="dis-block icon-header-item cl2 hov-cl1 trans-04 p-r-11 p-l-10 icon-header-noti"
                    data-notify="0">
                    <i class="zmdi zmdi-favorite-outline"></i>
                </a>
            </div>
            <div class="btn-show-menu-mobile hamburger hamburger--squeeze">
                <span class="hamburger-box">
                    <span class="hamburger-inner"></span>
                </span>
            </div>
        </div>

        <!-- Menu Mobile -->
        <div class="menu-mobile">
            <ul class="topbar-mobile">
                <li>
                    <div class="left-top-bar">Free shipping for standard order over $100</div>
                </li>
                <li>
                    <div class="right-top-bar flex-w h-full">
                        <a href="#" class="flex-c-m p-lr-10 trans-04">Help & FAQs</a>
                        <a href="#" class="flex-c-m p-lr-10 trans-04">My Account</a>
                        <a href="#" class="flex-c-m p-lr-10 trans-04">EN</a>
                        <a href="#" class="flex-c-m p-lr-10 trans-04">VN</a>
                    </div>
                </li>
            </ul>
            <ul class="main-menu-m">
                <li><a href="index.html">Home</a></li>
                <li><a href="product.html">Shop</a></li>
                <li><a href="shoping-cart.html">Features</a></li>
                <li><a href="blog.html">Blog</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </div>
    </header>

    <!-- breadcrumb -->
    <div class="container">
        <div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
            <a href="index.html" class="stext-109 cl8 hov-cl1 trans-04">Home <i
                    class="fa fa-angle-right m-l-9 m-r-10"></i></a>
            <a href="shoping-cart.html" class="stext-109 cl8 hov-cl1 trans-04">Gi·ªè h√†ng <i
                    class="fa fa-angle-right m-l-9 m-r-10"></i></a>
            <span class="stext-109 cl4">Thanh to√°n</span>
        </div>
    </div>

    <!-- Checkout -->
    <div class="checkout-container">
        <div class="container">
            <a href="shoping-cart.html" class="btn-back">‚Üê Quay l·∫°i gi·ªè h√†ng</a>

            <div id="errorAlert" class="alert-danger" style="display: none;"></div>
            <div id="infoAlert" class="alert-info" style="display: none;"></div>

            <div class="grid-2">
                <!-- Left: Th√¥ng tin giao h√†ng -->
                <div>
                    <div class="checkout-section">
                        <div class="section-title">Th√¥ng tin giao h√†ng</div>

                        <div class="form-group">
                            <label>H·ªç t√™n ng∆∞·ªùi nh·∫≠n *</label>
                            <input type="text" id="tenNguoiNhan" placeholder="Nh·∫≠p h·ªç t√™n" required>
                        </div>

                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="email" placeholder="your@email.com" required>
                        </div>

                        <div class="form-group">
                            <label>S·ªë ƒëi·ªán tho·∫°i *</label>
                            <input type="tel" id="soDienThoai" placeholder="0987654321" required>
                        </div>

                        <div class="form-group">
                            <label>ƒê·ªãa ch·ªâ giao h√†ng *</label>
                            <input type="text" id="diaChiNhan" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß" required>
                        </div>

                        <div class="form-group">
                            <label>T·ªânh/Th√†nh ph·ªë *</label>
                            <select id="tinhThanh" required>
                                <option value="">-- Ch·ªçn t·ªânh/th√†nh ph·ªë --</option>
                                <option value="HN">H√† N·ªôi</option>
                                <option value="HCM">Th√†nh ph·ªë H·ªì Ch√≠ Minh</option>
                                <option value="DN">ƒê√† N·∫µng</option>
                                <option value="HP">H·∫£i Ph√≤ng</option>
                                <option value="CT">C·∫ßn Th∆°</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Ghi ch√∫ ƒë∆°n h√†ng</label>
                            <textarea id="ghiChu" rows="3" placeholder="Ghi ch√∫ th√™m (kh√¥ng b·∫Øt bu·ªôc)"></textarea>
                        </div>
                    </div>

                    <div class="checkout-section">
                        <div class="section-title">Ph∆∞∆°ng th·ª©c thanh to√°n</div>

                        <div class="payment-method">
                            <label class="payment-option active">
                                <input type="radio" name="phuongThuc" value="COD" checked>
                                <div style="margin-top: 10px;">
                                    <div style="font-weight: 600;">Thanh to√°n khi nh·∫≠n h√†ng</div>
                                    <div style="font-size: 12px; color: #666;">COD</div>
                                </div>
                            </label>

                            <label class="payment-option">
                                <input type="radio" name="phuongThuc" value="VNPay">
                                <div style="margin-top: 10px;">
                                    <div style="font-weight: 600;">VNPay</div>
                                    <div style="font-size: 12px; color: #666;">Thanh to√°n tr·ª±c tuy·∫øn</div>
                                </div>
                            </label>
                        </div>

                        <div id="vnpayInfo" class="alert-info" style="display: none; margin-top: 15px;">
                            <strong>L∆∞u √Ω:</strong> B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn trang VNPay ƒë·ªÉ ho√†n t·∫•t thanh to√°n.
                        </div>
                    </div>
                </div>

                <!-- Right: T√≥m t·∫Øt ƒë∆°n h√†ng -->
                <div>
                    <div class="checkout-section">
                        <div class="section-title">T√≥m t·∫Øt ƒë∆°n h√†ng</div>

                        <div id="productList"></div>

                        <div class="order-summary">
                            <div class="summary-row">
                                <span>T·∫°m t√≠nh:</span>
                                <span id="tamTinh">0 ‚Ç´</span>
                            </div>
                            <div class="summary-row">
                                <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                                <span id="phiVanChuyen">Mi·ªÖn ph√≠</span>
                            </div>
                            <div class="summary-row">
                                <span>Gi·∫£m gi√°:</span>
                                <span id="giamGia">0 ‚Ç´</span>
                            </div>
                            <div class="summary-row total">
                                <span>T·ªïng ti·ªÅn:</span>
                                <span id="tongTien">0 ‚Ç´</span>
                            </div>
                        </div>

                        <button id="btnDatHang" class="btn-checkout">X√°c nh·∫≠n ƒë·∫∑t h√†ng</button>

                        <div class="loading" id="loading">
                            <div class="spinner"></div>
                            <p>ƒêang x·ª≠ l√Ω thanh to√°n...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg3 p-t-75 p-b-32">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-lg-3 p-b-50">
                    <h4 class="stext-301 cl0 p-b-30">Danh m·ª•c</h4>
                    <ul>
                        <li class="p-b-10"><a href="#" class="stext-107 cl7 hov-cl1 trans-04">√Åo</a></li>
                        <li class="p-b-10"><a href="#" class="stext-107 cl7 hov-cl1 trans-04">Qu·∫ßn</a></li>
                        <li class="p-b-10"><a href="#" class="stext-107 cl7 hov-cl1 trans-04">V√°y</a></li>
                        <li class="p-b-10"><a href="#" class="stext-107 cl7 hov-cl1 trans-04">Gi√†y</a></li>
                    </ul>
                </div>

                <div class="col-sm-6 col-lg-3 p-b-50">
                    <h4 class="stext-301 cl0 p-b-30">H·ªó tr·ª£</h4>
                    <ul>
                        <li class="p-b-10"><a href="#" class="stext-107 cl7 hov-cl1 trans-04">Li√™n h·ªá</a></li>
                        <li class="p-b-10"><a href="#" class="stext-107 cl7 hov-cl1 trans-04">V·ªÅ ch√∫ng t√¥i</a></li>
                        <li class="p-b-10"><a href="#" class="stext-107 cl7 hov-cl1 trans-04">ƒêi·ªÅu kho·∫£n</a></li>
                        <li class="p-b-10"><a href="#" class="stext-107 cl7 hov-cl1 trans-04">Ch√≠nh s√°ch</a></li>
                    </ul>
                </div>

                <div class="col-sm-6 col-lg-3 p-b-50">
                    <h4 class="stext-301 cl0 p-b-30">Theo d√µi ch√∫ng t√¥i</h4>
                    <p class="stext-107 cl7 size-201">H√£y theo d√µi trang c·ªßa ch√∫ng t√¥i ƒë·ªÉ c·∫≠p nh·∫≠t s·∫£n ph·∫©m m·ªõi.</p>
                    <div class="p-t-27">
                        <a class="fab fa-facebook-f" href="#"></a>
                        <a class="fab fa-twitter" href="#"></a>
                        <a class="fab fa-instagram" href="#"></a>
                    </div>
                </div>

                <div class="col-sm-6 col-lg-3 p-b-50">
                    <h4 class="stext-301 cl0 p-b-30">Li√™n h·ªá</h4>
                    <form>
                        <div class="wrap-input1 w-full p-b-4">
                            <input class="input1 bg-none s-text7 plh3" type="text" name="email"
                                placeholder="your@email.com">
                            <button class="flex-c-m size-21 bg1 how-btn1 trans-04">
                                <i class="fa fa-long-arrow-right"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="p-t-40">
                <p class="stext-107 cl6 txt-center">
                    Copyright &copy;
                    <script>document.write(new Date().getFullYear());</script> All rights reserved | Made with <i
                        class="fa fa-heart-o" aria-hidden="true"></i>
                </p>
            </div>
        </div>
    </footer>

    <!-- Back to top -->
    <div class="btn-back-to-top" id="myBtn">
        <span class="symbol-btn-back-to-top">
            <i class="zmdi zmdi-chevron-up"></i>
        </span>
    </div>

    <script src="vendor/jquery/jquery-3.2.1.min.js"></script>
    <script src="vendor/animsition/js/animsition.min.js"></script>
    <script src="vendor/bootstrap/js/popper.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="vendor/select2/select2.min.js"></script>
    <script src="vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
    <script src="vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="js/main.js"></script>

    <script>
        $(document).ready(function () {
            const nguoiDungId = 11; // ID ng∆∞·ªùi d√πng ƒëang ƒëƒÉng nh·∫≠p
            const apiUrl = `http://localhost:5150/api/GioHang/ChiTiet/${nguoiDungId}`;
            const orderUrl = `http://localhost:5150/api/DonHang/create`;
            const paymentUrl = `http://localhost:5150/api/ThanhToan/create-payment-url`;

            // Load gi·ªè h√†ng
            function loadCartItems() {
                $.ajax({
                    url: apiUrl,
                    method: "GET",
                    dataType: "json",
                    success: function (res) {
                        console.log("‚úÖ D·ªØ li·ªáu gi·ªè h√†ng:", res);

                        if (!res || !res.items || res.items.length === 0) {
                            $("#errorAlert").html("Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng. <a href='shoping-cart.html'>Quay l·∫°i gi·ªè h√†ng</a>").show();
                            $("#btnDatHang").prop("disabled", true);
                            return;
                        }

                        let productHtml = '';
                        res.items.forEach(item => {
                            const anhUrl = item.anh || '/images/icons/default-image.png';
                            productHtml += `
                                <div class="product-item">
                                    <img src="${anhUrl}" alt="${item.tenSp}">
                                    <div class="product-info">
                                        <div class="product-name">${item.tenSp}</div>
                                        <div class="product-qty">S·ªë l∆∞·ª£ng: ${item.soLuong}</div>
                                        <div class="product-price">${(item.gia || 0).toLocaleString()} ‚Ç´ x ${item.soLuong} = ${(item.thanhTien || 0).toLocaleString()} ‚Ç´</div>
                                    </div>
                                </div>
                            `;
                        });

                        $("#productList").html(productHtml);
                        const tongTien = res.tongTien || 0;
                        $("#tamTinh").text((tongTien).toLocaleString() + " ‚Ç´");
                        $("#tongTien").text((tongTien).toLocaleString() + " ‚Ç´");

                        // L∆∞u d·ªØ li·ªáu gi·ªè v√†o session storage ƒë·ªÉ x·ª≠ l√Ω khi thanh to√°n
                        sessionStorage.setItem('cartData', JSON.stringify(res));
                    },
                    error: function (xhr) {
                        console.error("‚ùå L·ªói t·∫£i gi·ªè h√†ng:", xhr.status, xhr.responseText);
                        $("#errorAlert").html("Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng. Vui l√≤ng th·ª≠ l·∫°i.").show();
                    }
                });
            }

            loadCartItems();

            // S·ª± ki·ªán thay ƒë·ªïi ph∆∞∆°ng th·ª©c thanh to√°n
            $('input[name="phuongThuc"]').change(function () {
                if ($(this).val() === 'VNPay') {
                    $("#vnpayInfo").show();
                } else {
                    $("#vnpayInfo").hide();
                }
                // C·∫≠p nh·∫≠t class active
                $(".payment-option").removeClass("active");
                $(this).closest(".payment-option").addClass("active");
            });

            // B·∫•m ƒë·∫∑t h√†ng
            $("#btnDatHang").click(function () {
                // Validate form
                const tenNguoiNhan = $("#tenNguoiNhan").val().trim();
                const email = $("#email").val().trim();
                const soDienThoai = $("#soDienThoai").val().trim();
                const diaChiNhan = $("#diaChiNhan").val().trim();
                const tinhThanh = $("#tinhThanh").val();
                const phuongThuc = $('input[name="phuongThuc"]:checked').val();

                if (!tenNguoiNhan || !email || !soDienThoai || !diaChiNhan || !tinhThanh) {
                    $("#errorAlert").html("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin (c√≥ d·∫•u *)").show();
                    return;
                }

                if (!/^[\d+\-\s\(\)]+$/.test(soDienThoai) || soDienThoai.length < 10) {
                    $("#errorAlert").html("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá").show();
                    return;
                }

                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    $("#errorAlert").html("Email kh√¥ng h·ª£p l·ªá").show();
                    return;
                }

                // L·∫•y d·ªØ li·ªáu gi·ªè h√†ng
                const cartData = JSON.parse(sessionStorage.getItem('cartData'));
                if (!cartData || !cartData.items || cartData.items.length === 0) {
                    $("#errorAlert").html("Gi·ªè h√†ng tr·ªëng").show();
                    return;
                }

                // Hi·ªÉn th·ªã loading
                $("#loading").show();
                $("#btnDatHang").prop("disabled", true);
                $("#errorAlert").hide();

                // Chu·∫©n b·ªã d·ªØ li·ªáu ƒë·∫∑t h√†ng
                const orderData = {
                    nguoiDungId: nguoiDungId,
                    tenNguoiNhan: tenNguoiNhan,
                    email: email,
                    soDienThoai: soDienThoai,
                    diaChiNhan: diaChiNhan,
                    tinhThanh: tinhThanh,
                    ghiChu: $("#ghiChu").val(),
                    phuongThuc: phuongThuc,
                    tongTien: cartData.tongTien,
                    danhSachSanPham: cartData.items.map(item => ({
                        sanPhamId: item.sanPhamID,
                        soLuong: item.soLuong,
                        gia: item.gia,
                        kichThuocId: item.kichThuocID
                    }))
                };

                console.log("üì¶ D·ªØ li·ªáu ƒë·∫∑t h√†ng:", orderData);

                // G·ª≠i t·∫°o ƒë∆°n h√†ng
                $.ajax({
                    url: orderUrl,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(orderData),
                    success: function (res) {
                        console.log("‚úÖ T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng:", res);

                        if (phuongThuc === 'VNPay') {
                            // T·∫°o URL thanh to√°n VNPay
                            createVNPayPayment(res.donHangId, res.tongTien);
                        } else {
                            // COD - ho√†n t·∫•t ƒë·∫∑t h√†ng
                            $("#loading").hide();
                            alert("‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng! ƒê∆°n h√†ng #" + res.donHangId + " s·∫Ω ƒë∆∞·ª£c giao trong 2-3 ng√†y.");
                            window.location.href = 'shoping-cart.html';
                        }
                    },
                    error: function (xhr) {
                        console.error("‚ùå L·ªói t·∫°o ƒë∆°n h√†ng:", xhr.status, xhr.responseText);
                        $("#loading").hide();
                        $("#btnDatHang").prop("disabled", false);
                        $("#errorAlert").html("L·ªói khi t·∫°o ƒë∆°n h√†ng: " + (xhr.responseJSON?.message || xhr.responseText)).show();
                    }
                });
            });

            // T·∫°o thanh to√°n VNPay
            function createVNPayPayment(donHangId, tongTien) {
                const paymentData = {
                    // Put the created order id into orderType so backend uses it as vnp_TxnRef
                    orderType: String(donHangId),
                    amount: tongTien,
                    orderDescription: `Thanh to√°n ƒë∆°n h√†ng #${donHangId}`,
                    name: $("#tenNguoiNhan").val()
                };

                $.ajax({
                    url: paymentUrl,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(paymentData),
                    success: function (res) {
                        console.log("‚úÖ T·∫°o URL thanh to√°n VNPay th√†nh c√¥ng:", res);
                        $("#loading").hide();
                        // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn VNPay
                        if (res.paymentUrl) {
                            window.location.href = res.paymentUrl;
                        } else {
                            $("#errorAlert").html("Kh√¥ng th·ªÉ l·∫•y URL thanh to√°n VNPay").show();
                            $("#btnDatHang").prop("disabled", false);
                        }
                    },
                    error: function (xhr) {
                        console.error("‚ùå L·ªói t·∫°o thanh to√°n VNPay:", xhr.status, xhr.responseText);
                        $("#loading").hide();
                        $("#btnDatHang").prop("disabled", false);
                        $("#errorAlert").html("L·ªói khi t·∫°o thanh to√°n: " + (xhr.responseJSON?.message || xhr.responseText)).show();
                    }
                });
            }
        });
    </script>

</body>

</html>